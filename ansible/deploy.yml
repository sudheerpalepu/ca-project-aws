---
- name: Deploy MyProject Web App on EC2
  hosts: web
  become: true

  tasks:
    # 1️⃣ Update apt cache
    - name: Update apt cache
      apt:
        update_cache: yes

    # 2️⃣ Install Docker using official convenience script
    - name: Install Docker
      shell: curl -fsSL https://get.docker.com | sh
      args:
        warn: false

    # 3️⃣ Ensure Docker service is running
    - name: Start Docker
      service:
        name: docker
        state: started
        enabled: true

    # 4️⃣ Build Docker image
    - name: Build Docker image
      docker_image:
        build:
          path: ~/myproject
        name: myapp
        tag: latest

    # 5️⃣ Stop and remove any running container
    - name: Stop old container
      docker_container:
        name: myapp
        state: absent
        force_kill: yes

    # 6️⃣ Run new container
    - name: Run container
      docker_container:
        name: myapp
        image: myapp:latest
        state: started
        restart_policy: always
        ports:
          - "80:80"